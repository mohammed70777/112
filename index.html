<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Binalsheikh Art</title>
</head>
<body>
    <div class="container">
        <div class="jumbotron" style="padding-bottom: 20px;">
            <div style="float: left; position: absolute; top: 20px;">
                <a href="https://www.instagram.com/al_binalshaikh/profilecard/?igsh=MTdqMTdtb3A1a2huaw%3D%3D">التواصل</a>
            </div>
            <h1>Binalsheikh Art</h1>
            <div style="float: right; margin-top: -40px;">
                <button class="btn btn-primary" onclick="onHasSteps();">انقر هنا</button>
            </div>
            <h2 id="status">Please wait: loading...</h2>
            <span>Wait for generate to complete loading. For best results, use close-up, high-contrast images.</span>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="numberOfPins">Number of Pins</label>
                        <input type="text" class="form-control" id="numberOfPins" placeholder="Default: 288">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="numberOfLines">Number of Lines</label>
                        <input type="text" class="form-control" id="numberOfLines" placeholder="Default: 4000">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="lineWeight">Line Weight</label>
                        <input type="text" class="form-control" id="lineWeight" placeholder="Default: 20">
                    </div>
                </div>
            </div>
            <label class="btn btn-primary btn-file">
                Click Here and select an Image to Start <input type="file" id="fileInput" style="display: none;">
            </label>
        </div>

        <div id="canvasContainer">
            <canvas id="canvasOutput" class="centerCanvasMedium"></canvas>
            <canvas id="canvasOutput2" class="centerCanvasLarge"></canvas>
            <canvas id="canvasOutput3" class="centerCanvasLarge"></canvas>
        </div>
    </div>

    <script src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script type="text/javascript">
        // Parameters
        const IMG_SIZE = 500;
        const MAX_LINES_DEFAULT = 4000;
        const N_PINS_DEFAULT = 288;
        const LINE_WEIGHT_DEFAULT = 20;
        let imgElement = document.getElementById("imageSrc");
        let inputElement = document.getElementById("fileInput");
        let canvas = document.getElementById("canvasOutput");
        let ctx = canvas.getContext("2d");

        // User-defined Variables
        let N_PINS = N_PINS_DEFAULT;
        let MAX_LINES = MAX_LINES_DEFAULT;
        let LINE_WEIGHT = LINE_WEIGHT_DEFAULT;

        let pinCoords = []; // Coordinates of pins

        // Event listener for file input
        inputElement.addEventListener("change", (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        });

        imgElement.onload = function() {
            initializeCanvas();
            calculatePins();
        }

        function initializeCanvas() {
            ctx.clearRect(0, 0, IMG_SIZE, IMG_SIZE);
            ctx.drawImage(imgElement, 0, 0, IMG_SIZE, IMG_SIZE);
            ctx.globalCompositeOperation = 'destination-in';
            ctx.beginPath();
            ctx.arc(IMG_SIZE / 2, IMG_SIZE / 2, IMG_SIZE / 2, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
        }

        function calculatePins() {
            console.log("Calculating pins...");
            pinCoords = [];
            const center = IMG_SIZE / 2;
            const radius = IMG_SIZE / 2 - 1;
            const rows = Math.sqrt(N_PINS);
            const cols = Math.sqrt(N_PINS);
            const pinSpacing = (IMG_SIZE - 2 * radius) / (rows - 1);

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    let x = center - radius + j * pinSpacing;
                    let y = center - radius + i * pinSpacing;
                    pinCoords.push([Math.floor(x), Math.floor(y)]);
                }
            }
            console.log("Pins calculated.");
            precalculateLines();
        }

        function precalculateLines() {
            console.log("Precalculating lines...");
            let lineCacheX = [];
            let lineCacheY = [];

            for (let a = 0; a < N_PINS; a++) {
                for (let b = a + 1; b < N_PINS; b++) {
                    let [x0, y0] = pinCoords[a];
                    let [x1, y1] = pinCoords[b];
                    let lineX = linspace(x0, x1, 50);
                    let lineY = linspace(y0, y1, 50);
                    lineCacheX.push(lineX);
                    lineCacheY.push(lineY);
                }
            }
            console.log("Lines precalculated.");
            drawLines(lineCacheX, lineCacheY);
        }

        function drawLines(lineCacheX, lineCacheY) {
            console.log("Drawing lines...");
            for (let i = 0; i < lineCacheX.length; i++) {
                ctx.beginPath();
                ctx.moveTo(lineCacheX[i][0], lineCacheY[i][0]);
                ctx.lineTo(lineCacheX[i][lineCacheX[i].length - 1], lineCacheY[i][lineCacheY[i].length - 1]);
                ctx.lineWidth = LINE_WEIGHT;
                ctx.strokeStyle = "black";
                ctx.stroke();
            }
            console.log("Lines drawn.");
        }

        function linspace(start, stop, num) {
            const arr = [];
            const step = (stop - start) / (num - 1);
            for (let i = 0; i < num; i++) {
                arr.push(Math.round(start + step * i));
            }
            return arr;
        }

        function onHasSteps() {
            document.getElementById("status").textContent = "Generator is ready.";
        }

        function onOpenCvReady() {
            console.log("OpenCV is ready.");
            document.getElementById("status").textContent = "Generator is ready.";
        }
    </script>
</body>
</html>
