<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <title>فنون بن الشيخ</title>
    <style>
        .hidden { display: none; }
        .centerCanvasLarge { display: block; margin: 20px auto; border: 1px solid #ddd; }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="jumbotron py-4">
            <div class="text-left mb-3">
                <a href="https://www.instagram.com/al_binalshaikh/profilecard/?igsh=MTdqMTdtb3A1a2huaw%3D%3D">اتصل بنا</a>
            </div>
            <h1 class="text-center">فنون بن الشيخ</h1>
            
            <div class="alert alert-info mt-4">
                <h5 id="status">يرجى الانتظار: جاري التحميل...</h5>
                <div id="loader" class="text-center mt-3">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>عدد الدبابيس</label>
                        <input type="number" class="form-control" id="numberOfPins" min="10" max="500">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>عدد الخطوط</label>
                        <input type="number" class="form-control" id="numberOfLines" min="100" max="10000">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>سماكة الخط</label>
                        <input type="number" class="form-control" id="lineWeight" min="1" max="50">
                    </div>
                </div>
            </div>

            <label class="btn btn-primary btn-block">
                اختر صورة لبدء التوليد <input type="file" id="fileInput" hidden>
            </label>
        </div>

        <!-- معاينة الصور -->
        <div class="row">
            <div class="col">
                <div id="processingSteps" class="text-center">
                    <canvas id="canvasOutput" class="hidden"></canvas>
                    <canvas id="canvasOutput2" class="hidden"></canvas>
                    <canvas id="canvasOutput3" class="hidden"></canvas>
                </div>
                <textarea id="pinsOutput" class="form-control mt-3 hidden" rows="5"></textarea>
            </div>
        </div>

        <!-- أدوات التحكم -->
        <div class="row mt-4">
            <div class="col text-center">
                <button class="btn btn-success" onclick="startCreating()">بدء الإنشاء</button>
                <button class="btn btn-info" onclick="startDrawing()">رسم تلقائي</button>
                <button class="btn btn-warning" onclick="lastStep()">خطوة للخلف</button>
                <button class="btn btn-primary" onclick="nextStep()">خطوة للأمام</button>
            </div>
        </div>
    </div>

    <script>
    // إعدادات عامة
    let IMG_SIZE = 500;
    let MAX_LINES = 4000;
    let N_PINS = 288;
    let LINE_WEIGHT = 20;
    let SCALE = 2;
    let stepsHistory = [];

    // عناصر DOM
    const elements = {
        imageSrc: document.getElementById("imageSrc"),
        status: document.getElementById("status"),
        loader: document.getElementById("loader"),
        canvasOutput: document.getElementById("canvasOutput"),
        canvasOutput2: document.getElementById("canvasOutput2"),
        canvasOutput3: document.getElementById("canvasOutput3"),
        pinsOutput: document.getElementById("pinsOutput")
    };

    // معالجة اختيار الصورة
    document.getElementById('fileInput').addEventListener('change', function(e) {
        try {
            const file = e.target.files[0];
            if (!file) return;
            
            elements.imageSrc.src = URL.createObjectURL(file);
            URL.revokeObjectURL(file);
            showLoader(true);
        } catch (error) {
            handleError(error);
        }
    });

    // تحميل الصورة
    elements.imageSrc.onload = async function() {
        try {
            await processImage();
            showLoader(false);
        } catch (error) {
            handleError(error);
        }
    };

    async function processImage() {
        // معالجة الصورة هنا...
    }

    // تحكم في الواجهة
    function showLoader(show) {
        elements.loader.style.display = show ? 'block' : 'none';
        elements.status.textContent = show ? 'جارٍ معالجة الصورة...' : 'جاهز';
    }

    function handleError(error) {
        console.error('حدث خطأ:', error);
        elements.status.textContent = 'حدث خطأ! يرجى المحاولة مرة أخرى.';
        showLoader(false);
    }

    // التحكم في الخطوات
    let currentStep = 0;
    const stepFunctions = {
        startCreating: () => { /* ... */ },
        startDrawing: () => { /* ... */ },
        nextStep: () => { /* ... */ },
        lastStep: () => { /* ... */ }
    };

    // تهيئة OpenCV
    function onOpenCvReady() {
        cv['onRuntimeInitialized'] = () => {
            elements.status.textContent = 'جاهز للاستخدام';
            setupEventListeners();
        };
    }

    function setupEventListeners() {
        document.getElementById('numberOfPins').addEventListener('input', function(e) {
            N_PINS = Math.min(500, Math.max(10, parseInt(e.target.value)));
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextStep();
            if (e.key === 'ArrowLeft') lastStep();
        });
    }

    // تهيئة التطبيق
    window.onload = () => {
        document.getElementById('numberOfPins').value = N_PINS;
        document.getElementById('numberOfLines').value = MAX_LINES;
        document.getElementById('lineWeight').value = LINE_WEIGHT;
    };
    </script>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady()"></script>
    <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
